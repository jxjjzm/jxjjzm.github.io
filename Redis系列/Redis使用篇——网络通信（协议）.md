### Redis使用篇——网络通信（协议） ###
***

### 一、连接的建立 ###

Redis通过监听一个TCP端口或者Unix socket的方式来接收来自客户端的连接，当一个连接建立后，Redis 内部会进行以下一些操作：

- 首先，客户端 socket 会被设置为非阻塞模式，因为 Redis 在网络事件处理上采用的是非阻塞多路复用模型。
- 然后为这个socket 设置 TCP_NODELAY 属性，禁用 [Nagle 算法](http://baike.baidu.com/view/2468335.htm)。
- 然后创建一个 readable 的文件事件用于监听这个客户端 socket 的数据发送。
- 当客户端连接被初始化后，Redis会查看目前的连接数，然后对比配置好的 maxclients 值，如果目前连接数已经达到最大连接数 maxclients 了（在 Redis2.4 中，最大连接数是被直接硬编码在代码里面的，而在2.6版本中这个值变成可配置的。maxclients 的默认值是 10000，你也可以在 redis.conf 中对这个值进行修改。当然，这个值只是 Redis 一厢情愿的值，Redis 还会照顾到系统本身对进程使用的文件描述符数量的限制。），那么说明这个连接不能再接收，Redis 会直接返回客户端一个连接错误，并马上关闭掉这个连接。（注：先建立连接，后检查，然后再断开，这样提高了并发量。）


为什么 Redis 中要使用 I/O 多路复用这种技术呢？

首先，Redis 是跑在单线程中的，所有的操作都是按照顺序线性执行的，但是由于读写操作等待用户输入或输出都是阻塞的，所以 I/O 操作在一般情况下往往不能直接返回，这会导致某一文件的 I/O 阻塞导致整个进程无法对其它客户提供服务，而 I/O 多路复用就是为了解决这个问题而出现的。

#### 1.I/O多路复用 ####


#### 2.Reactor设计模式 ####


### 二、服务端处理顺序 ###

如果有多个客户端连接上 Redis，并且都向 Redis 发送命令，那么 Redis 服务端会先处理哪个客户端的请求呢？答案其实并不确定，主要与两个因素有关，一是客户端对应的 socket 对应的数字的大小，二是 kernal 报告各个客户端事件的先后顺序。Redis 处理一个客户端传来数据的步骤如下：


- 它对触发事件的 socket 调用一次 read()，只读一次（而不是把这个 socket 上的消息读完为止），是为了防止由于某个别客户端持续发送太多命令，导致其它客户端的请求长时间得不到处理的情况。
- 当然，当这一次 read() 调用完成后，它里面无论包含多少个命令，都会被一次性顺序地执行。这样就保证了对各个客户端命令的公平对待。


### 三、通信协议 ###


我们知道客户端和服务器通过 TCP 连接来进行数据交互， 服务器默认的端口号为 6379 。Redis 服务器接受命令以及命令的参数。服务器会在接到命令之后，对命令进行处理，并将命令的回复传送回客户端（客户端和服务器发送的命令或数据一律以 \r\n （CRLF）结尾）。

Redis通信协议是Redis客户端与Redis之间交流的语言，通信协议规定了命令和返回值的格式。Redis支持两种通信协议，一种是二进制安全的统一请求协议（统一请求协议在 Redis 1.2 版本中引入， 并最终在 Redis 2.0 版本成为 Redis 服务器通信的标准方式。），一种是比较直观的便于在telnet程序中输入的简单协议。这两种协议只是命令的格式有区别，命令返回值的格式是一样的。

#### 1.请求 ####

统一请求协议的一般形式：

	*<参数数量> CR LF
	$<参数 1 的字节数量> CR LF
	<参数 1 的数据> CR LF
	...
	$<参数 N 的字节数量> CR LF
	<参数 N 的数据> CR LF

举个例子（set mykey myvalue）， 以下是一个命令协议的打印版本：

	*3
	$3
	SET
	$5
	mykey
	$7
	myvalue

这个命令的实际协议值如下：

	"*3\r\n$3\r\nSET\r\n$5\r\nmykey\r\n$7\r\nmyvalue\r\n"


#### 2.回复 ####

Redis 命令会返回多种不同类型的回复。通过检查服务器发回数据的第一个字节， 可以确定这个回复是什么类型：


- 状态回复（status reply）： 一个状态回复（或者单行回复，single line reply）是一段以 "+" 开始、 "\r\n" 结尾的单行字符串。
- 错误回复（error reply）： 错误回复和状态回复非常相似， 它们之间的唯一区别是， 错误回复的第一个字节是 "-" ， 而状态回复的第一个字节是 "+" 。错误回复只在某些地方出现问题时发送： 比如说， 当用户对不正确的数据类型执行命令， 或者执行一个不存在的命令， 等等。一个客户端库应该在收到错误回复时产生一个异常。
- 整数回复（integer reply）： 整数回复就是一个以 "：" 开头， CRLF 结尾的字符串表示的整数。返回整数回复的其中两个命令是 INCR 和 LASTSAVE 。 被返回的整数没有什么特殊的含义， INCR 返回键的一个自增后的整数值， 而 LASTSAVE 则返回一个 UNIX 时间戳， 返回值的唯一限制是这些数必须能够用 64 位有符号整数表示。整数回复也被广泛地用于表示逻辑真和逻辑假： 比如 EXISTS 和 SISMEMBER 都用返回值 1 表示真， 0 表示假。
- 批量回复（bulk reply）： 只有一个参数的回复格式被称为批量回复。批量回复的第一个字节是 "$"，接下来跟着的是表示实际回复长度的数字值，之后跟着一个 CRLF，再后面跟着的是实际回复数据，最末尾是另一个 CRLF
- 多条批量回复（multi bulk reply）： 将列表的多个项返回给客户端的， 这种回复格式被称为多条批量回复。多条批量回复的第一个字节为 "*" ， 后跟一个字符串表示的整数值， 这个值记录了多条批量回复所包含的回复数量， 再后面是一个 CRLF 。



















































































































































