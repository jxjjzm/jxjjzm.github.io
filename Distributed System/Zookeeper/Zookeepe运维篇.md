### Zookeepe运维篇 ###
***

### 一、配置详解 ###

#### 1.基本配置 ####

所谓基本的配置参数是指这些配置参数都是Zookeeper运行时所必须的，如果不配置这些参数，将无法启动Zookeeper服务器。同时，Zookeeper也会为这些参数设置默认值。这些基本的配置参数包括clientPort、dataDir和tickTime.

![](https://i.imgur.com/TCj3enx.png)


#### 2.高级配置 ####

![](https://i.imgur.com/frQL7Fk.png)
![](https://i.imgur.com/HwPt7lR.jpg)
![](https://i.imgur.com/u5ra33Z.jpg)
![](https://i.imgur.com/pjxCtJs.jpg)
![](https://i.imgur.com/d8p6LAS.png)


### 二、四字命令 ###



- telnet ip port —— 使用telnet客户端登录Zookeeper的对外服务端口；
- conf —— 用于输出Zookeeper服务器运行时使用的基本配置信息；
- cons —— 用于输出当前这台服务器上所有客户端连接的详细信息；
- crst —— 用于重置所有的客户端连接信息；
- dump —— 用于输出当前集群的所有会话信息；
- envi —— 用于输出Zookeeper所在服务器运行时的环境信息；
- ruok —— 用于输出当前Zookeeper服务器是否正在运行；
- stat —— 用于获取Zookeeper服务器的运行时状态信息；
- srvr —— 和stat命令功能一致，唯一的区别是srvr不会将客户端的连接情况输出，仅仅输出服务器的自身信息；
- srst —— 用于重置所有服务器的统计信息；
- wchs —— 用于输出当前服务器管理的Watcher的概要信息；
- wchc —— 用与输出当前服务器上管理的Watcher的详细信息，以会话为单位进行归组，同时列出被该会话注册了Watcher的节点路径；
- wchp —— 用于输出当前服务器上管理的Watcher的详细信息，不同点在于wchp命令的输出信息以节点路径为单位进行归组；
- mntr —— 用于输出比stat命令更为详尽的服务器统计信息；


### 三、JMX ###


从Apache官方网站上下载的Zookeeper，默认开启了JMX功能，但是却只限本地连接，无法通过远程连接，读者可以打开%ZK_HOME%bin目录下的zkServer.sh 文件，在这个配置中并没有开启远程连接JMX的端口信息，通常需要加入以下三个配置才能开启远程JMX：

	-Dcom.sun.management.jmxremote.port=5000
	-Dcom.sun.management.jmxremote.ssl=false
	-Dcom.sun.management.jmxremote.authenticate=false



### 四、监控 ###

关于Zookeeper监控，这里主要介绍下阿里中间件的软负载团队开发的TaoKeeper监控系统，TaoKeeper主要从实时监控和数据统计两方面来保障Zookeeper集群的稳定性。

#### 1.实时监控 ####

所谓实时监控，是指相对实时地对运行中的Zookeeper集群进行运行状态监控，包括对Zookeeper节点可用性的监控和集群读写TPS的监控。



- 节点可用性自检 —— 节点可用性自检是指对一个Zookeeper集群中每个服务器节点上的指定数据节点/TAOKEEPER.MONITOR.ALIVE.CHECK定期进行三次如下操作系列：

		创建连接 —— 发布数据 —— 接收数据更新通知 —— 获取数据 —— 对比数据

三次流程均成功且每次耗费的时间在指定的时间范围内即可视为该节点处于正常状态。



- 读写TPS监控 


#### 2.数据统计 ####

上面提到了Zookeeper的四字命令能够帮助我们获取到Zookeeper的运行时数据，Taokeeper将这些四字命令的返回结果进行了整合，同时持久化到数据库中，这样一来，我们就能够可视化地看到Zookeeper的运行时数据，并且还能看到这些数据的变化趋势，包括连接数、订阅者数、数据节点总数以及收发的数据量大小等。


### 五、构建一个高可用的集群 ###

#### 1.集群组成 ####

要搭建一个高可用的Zookeeper集群，我们首先需要确定好集群的规模。关于Zookeeper集群的服务器组成，相信很多对Zookeeper了解但是理解不深入的读者，都存在或曾经存在过这样一个错误的认识：为了使得Zookeeper集群能够顺利地选举出Leader，必须将Zookeeper集群的服务器数部署成奇数。这种说法毫无疑问是不正确的，这里我们需要澄清的一点是：任意台Zookeeper服务器都能部署且能够正常运行。（集群模式一般至少两台）

那么存在于这么多读者中的这个错误认识是怎么回事呢？其实关于Zookeeper集群服务器数，Zookeeper官方确实给出了关于奇数的建议，但绝大部分Zookeeper用户对这个建议认识有偏差。基于“过半”设计特性，一个Zookeeper集群如果要对外提供可用的服务，那么集群中必须要有过半的机器正常工作并且彼此之间能够正常通信。基于这个特性，如果想搭建一个能够允许F台机器down掉的集群，那么就要部署一个由2×F+1台服务器构成的Zookeeper集群。因此，一个由5台服务器构成的Zookeeper集群，能够对2台机器挂掉的情况下进行容灾。注意，如果是一个由6台服务器构成的Zookeeper集群，同样只能够挂掉2台机器，因为如果挂掉3台，剩下的机器就无法实现过半了。基于这个原因，Zookeeper集群通常设计部署成奇数台服务器即可。

#### 2.容灾 ####

所谓容灾，在IT行业通常是指我们的计算机信息系统具有的一种在遭受诸如火灾、水灾、地震、断电和其他基础网络设备故障等毁灭性灾难的时候，依然能够对外提供可用服务的能力。

- 单点问题 —— 单点问题是指在一个分布式系统中，如果某一个组件出现故障就会引起整个系统的可用性大大下降甚至是处于瘫痪状态，那么我们就认为该组件存在单点问题。Zookeeper确实已经很好地解决了单点问题，基于“过半”设计原则，Zookeeper在运行期间，集群中至少有过半的机器保存了最新的数据。因此，只要集群中超过半数的机器还能够正常工作，整个集群就能够对外提供服务。
- 多机房部署 —— 如果整个机房出现灾难性的事故，这时显然已经不是单点问题的范畴了。这时需要考虑到多机房部署（通常有以下两种部署方案：三机房部署或双机房部署）


#### 3.扩容与缩容 ####

水平可扩容可以说是对一个分布式系统在高可用方面提出的基本的，也是非常重要的一个要求，通过水平扩容能够帮助系统在不进行或进行极少改进工作的前提下，快速提高系统对外的服务支撑能力。简单地讲，水平扩容就是向集群中添加更多的机器，以提高系统的服务容量。很遗憾的是，Zookeeper在水平扩容方面做得并不是十分完美，需要进行整个集群的重启。通常有两种重启方式：一种是集群整体重启，另一种是逐台进行服务器的重启。

- 整体重启：所谓集群整体重启，就是先将整个集群停止，然后更新Zookeeper的配置，然后再次启动。
- 逐台重启：这种方式似乎更适合绝大多数的实际场景。在这种方式中，每次仅仅重启集群中的一台机器，然后逐台对整个集群中的机器进行重启操作。这种方式可以在重启期间依然保证集群对外的正常服务。




### 六、日常运维 ###

#### 1.数据与日志管理 ####

我们了解到Zookeeper服务器会有dataDir和dataLogDir两个目录，分别用于存储快照数据和事务日志。正常运行过程中，Zookeeper会不断地把快照数据和事务日志输出到这两个目录，并且如果没有人为操作的话，默认情况下Zookeeper自己是不会清理这些文件的，需要运维人员来进行清理。

- 纯Shell脚本进行清理
- 使用清理工具：PurgeTxnLog —— Zookeeper提供了一个工具类 org.apache.zookeeper.server.PurgeTxnLog,实现了一种较为简单的文件清理策略，运维人员可以使用该工具进行历史文件的清理。

![](https://i.imgur.com/Zcr00Vc.png)

- 使用清理脚本：zkCleanup.sh  —— 在Zookeeper发布包中已经为用户准备了脚本：zkCleanup.sh,用来封装清理工具PurgeTxnLog,如 sh zkCleanup.sh -n 15
- 自动清理机制 —— 从3.4.0版本开始，Zookeeper提供了一种自动清理历史快照数据和事务日志文件的机制，使用方式是通过配置 autoPurge.anapRetainCount 和 autopurge.purgeInterval这两个参数来实现定时清理。






#### 2.Too many connections ####

我们前面提到过maxClientCnxns参数，该参数用于设置Zookeeper服务器运行时允许单个客户端机器创建的最大连接数。如果超过了上面设定的参数值，那么服务器就会拒绝与该客户端的连接（注意，触发了Zookeeper服务端的“拒绝创建连接”后，在参数值范围内创建的客户端连接不会受到影响，只会拒绝超出部分的客户端连接请求）。同时，服务器会打印出 Too many connections 的警告日志。


#### 3.磁盘管理 ####

我们知道Zookeeper对于磁盘的依赖非常严重。在Zookeeper中，但凡对Zookeeper数据状态的变更，都会以事务日志的形式写入磁盘，并且只有当集群中过半的服务器已经记录了该事务日志后，服务器才会给予客户端响应。另一方面，Zookeeper还会定时将内存数据库中的所有数据和所有客户端的会话信息记录进行快照，保存到磁盘上的数据快照文件中去。因此，磁盘的IO性能直接制约着Zookeeper每个更新操作的处理速度。为了尽量减少Zookeeper在读写磁盘上的性能损失，可以尝试以下几点：

- 使用单独的磁盘作为事务日志的输出目录。
- 尽量避免内存与磁盘空间的交换。

















